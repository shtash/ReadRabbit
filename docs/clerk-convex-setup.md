# Clerk + Convex Setup Guide

Complete guide for setting up Clerk authentication with Convex backend for ReadRabbit.

## Prerequisites

- Node.js installed
- Clerk account created at https://clerk.com
- Convex account created at https://convex.dev

---

## Step 1: Create Clerk Application

1. Go to https://dashboard.clerk.com
2. Click **"Create application"**
3. Name it **"ReadRabbit"**
4. Select authentication methods:
   - ✅ Email/Password
   - ✅ Google
   - ✅ (Optional) Other social providers
5. Click **Create**

---

## Step 2: Get Clerk API Keys

1. In Clerk Dashboard, go to **API Keys**
2. Copy these values:
   - **Publishable Key** (starts with `pk_test_...`)
   - **Secret Key** (starts with `sk_test_...`)
   - **Issuer URL** (looks like `https://your-app-123.clerk.accounts.dev`)

---

## Step 3: Configure JWT Template ⚠️ CRITICAL

This step is **required** for Convex mutations to work with Clerk auth.

1. In Clerk Dashboard, navigate to: **Configure** → **Sessions** → **JWT Templates**
2. Click **"New template"**
3. Select **"Convex"** from the dropdown (pre-configured template)
   - OR create a **Blank** template with these settings:
     - **Name**: `convex`
     - **Token Lifetime**: `3600` seconds
     - **Claims**: Leave default (includes `sub`, `iss`, `iat`, `exp`)
4. Click **Save**

**Why this matters:** Without this template, Convex mutations will fail with "Not authenticated" even though queries work.

---

## Step 4: Set Up Local Environment Variables

Create/edit `web/.env.local`:

```bash
# Clerk Keys (from Step 2)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...

# Convex (auto-generated by npx convex dev)
CONVEX_DEPLOYMENT=dev:...
NEXT_PUBLIC_CONVEX_URL=https://...

# AI Services (add later)
OPENAI_API_KEY=sk-...
NANO_BANANA_API_KEY=...
```

**Note:** `CONVEX_DEPLOYMENT` and `NEXT_PUBLIC_CONVEX_URL` are automatically added when you run `npx convex dev`.

---

## Step 5: Set Convex Environment Variables

1. Go to https://dashboard.convex.dev
2. Select your **ReadRabbit** project
3. Navigate to: **Settings** → **Environment Variables**
4. Make sure you're on the **"Development"** tab
5. Add this variable:
   - **Key**: `CLERK_JWT_ISSUER_DOMAIN`
   - **Value**: `https://your-app-123.clerk.accounts.dev` (from Step 2, Issuer URL)
   
**Important:** Use the **domain only**, NOT the full JWKS URL (don't include `/.well-known/jwks.json`)

---

## Step 6: Verify Setup

### Terminal Check

```bash
cd web
npx convex dev
```

Should show:
```
✓ Deployment URL: https://...
✓ Environment variables loaded
```

### Browser Check

1. Start dev server: `npm run dev`
2. Open `http://localhost:3000`
3. Click **"Sign Up"**
4. Create test account with Google or email
5. After sign-up, open browser console (F12)
6. Look for: `✅ Convex user created`

### Database Check

```bash
cd web
npx convex run migrations:listUsers
```

Should output:
```json
{
  "count": 1,
  "users": [
    {
      "email": "your-email@example.com",
      "name": "Your Name",
      "onboardingCompleted": false,
      ...
    }
  ]
}
```

---

## Common Issues

### "Not authenticated" error in Convex logs

**Cause:** Missing or incorrect JWT template in Clerk  
**Fix:** Complete Step 3 above, then sign out and sign in again

### Users not appearing in Convex database

**Causes:**
1. Wrong `CLERK_JWT_ISSUER_DOMAIN` in Convex (check Step 5)
2. Missing JWT template (check Step 3)
3. Cached auth tokens in browser

**Fix:**
1. Verify all environment variables
2. Sign out completely
3. Clear browser cache or use incognito mode
4. Sign in again

### Wrong domain format

❌ **Wrong:** `https://your-app.clerk.accounts.dev/.well-known/jwks.json`  
✅ **Correct:** `https://your-app.clerk.accounts.dev`

---

## Testing Onboarding Flow

After setup is complete:

1. Create a new account (or use the migration script to reset)
2. After sign-up, you should see the onboarding tutorial
3. Tutorial shows 4 steps explaining the bottom nav icons
4. After completion, redirects to Parent Dashboard

To reset onboarding for testing:

```bash
cd web
npx convex run migrations:resetOnboarding --adminOnly true
```

---

## Architecture Overview

```
Browser (Clerk Session)
    ↓ JWT Token
Next.js App
    ↓ ConvexProviderWithClerk
Convex Backend
    ↓ Validates via JWT Template
Database Operations
```

1. User signs in with Clerk
2. Clerk issues a JWT token
3. Next.js sends token to Convex with each request
4. Convex validates token using `CLERK_JWT_ISSUER_DOMAIN` + JWT template
5. If valid, `ctx.auth.getUserIdentity()` returns user info
6. Mutations/queries can access authenticated user data

---

## Related Files

- [`web/src/app/ConvexClientProvider.tsx`](file:///home/joe/Documents/code/apps/ReadRabbit/web/src/app/ConvexClientProvider.tsx) - Clerk + Convex integration
- [`web/src/middleware.ts`](file:///home/joe/Documents/code/apps/ReadRabbit/web/src/middleware.ts) - Route protection
- [`web/convex/auth.config.ts`](file:///home/joe/Documents/code/apps/ReadRabbit/web/convex/auth.config.ts) - Convex auth configuration
- [`web/convex/users.ts`](file:///home/joe/Documents/code/apps/ReadRabbit/web/convex/users.ts) - User management functions

---

## Additional Resources

- [Clerk Docs: Next.js Quickstart](https://clerk.com/docs/quickstarts/nextjs)
- [Convex Docs: Clerk Auth](https://docs.convex.dev/auth/clerk)
- [Clerk JWT Templates](https://clerk.com/docs/backend-requests/making/jwt-templates)
